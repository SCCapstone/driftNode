
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />

<title>ROS GPS Visualizer</title>

<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
<link rel="stylesheet" href="css/jquery.mobile-1.3.1.min.css" />
<script type="text/javascript" src="js/eventemitter2.min.js"></script>
<script type="text/javascript" src="js/roslib.min.js"></script>
<script src="js/jquery-1.9.1.min.js"></script>
<script src="js/jquery.mobile-1.3.1.min.js"></script>

<style>
.ui-collapsible-content {
  padding: 4px;
}

#map-canvas {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 600px;
}
</style>

<script>
//FIXED BY: Daniel Boydstun

var map;
var initPos = new google.maps.LatLng(45.504824264187214, -73.57661962509155);
var styleArray = [
  {
  featureType: "road",
  stylers: [
    { visibility: "off" }
    ]
  }
];
google.maps.visualRefresh = true;


function initializeMap() {
  var mapOptions = {
    zoom: 19,
    center: initPos,
    panControl: true,
    zoomControl: true,
    mapTypeControl: true,
    scaleControl: true,
    streetViewControl: false,
    mapTypeId: google.maps.MapTypeId.HYBRID
  };
  map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
}
google.maps.event.addDomListener(window, 'load', initializeMap);


var ros = new ROSLIB.Ros();
var connected = false;
var listenerGPS = null;
var prevGPSMsgTime = new Date();
var markers = new Array();
var waypointLines = null;

function callbackGPS(msg) {
  var GPSMsgTime = new Date();
  
  var msgps = parseFloat($('#gps_msg_rate').val());
  if (msgps < 0) msgps = 0;
  if (msgps > 0 && (GPSMsgTime - prevGPSMsgTime) < 1000/msgps) {
    return;
  }
  prevGPSMsgTime = GPSMsgTime;
  
  var lat = msg.latitude;
  var lon = msg.longitude;
  var time = msg.header.stamp.secs + msg.header.stamp.nsecs/1e9;
  var str = time.toString() + ' @ (' + lat.toString() + ',' + lon.toString() + ')';
  $('#gps_latest_latlon').val('(' + lat.toString() + ',' + lon.toString() + ')');
  $('#gps_latest_time').val(time.toString());
  
  console.log('Recv GPS (' + lat.toString() + ',' + lon.toString() + ') @ ' + time.toString());

  var maxNumMarkers = parseInt($('#gps_max_num_markers').val());
  if (maxNumMarkers > 0) {
    while (markers.length >= maxNumMarkers) {
      var removedMarker = markers.shift();
      removedMarker.setMap(null);
    }
  }
  
  markers.push(new google.maps.Marker({
    map: map,
    draggable: false,
    clickable: true,
    title: str,
    animation: google.maps.Animation.DROP,
    position: new google.maps.LatLng(lat, lon)
  }));
  
  var waypointCoordinates = new Array();
  var i;
  for (i = 0; i < markers.length; i++) {
    waypointCoordinates[i] = markers[i].position;
  }
  if (waypointLines != null) {
    waypointLines.setMap(null);
  }
  waypointLines = new google.maps.Polyline({
    path: waypointCoordinates,
    strokeColor: "#FFFFFF",
    strokeOpacity: 0.8,
    strokeWeight: 4
  });
  waypointLines.setMap(map);
};


function clearWaypoints() {
  while (markers.length > 0) {
    var removedMarker = markers.pop();
    removedMarker.setMap(null);
  }
  console.log('1');
  
  if (waypointLines != null) {
    waypointLines.setMap(null);
  }
  console.log('2');

  $('#gps_clear_markers').parent().removeClass('ui-btn-active');
};


$(function() {
  $('form').submit(false);
  
  $('#gps_clear_markers').click(function() {
    clearWaypoints();
  });
  
  // TODO: disable blue glow on "Clear Markers" button
});


function toggleConnection() {
  	if (connected) 
	{ // Disconnect from ROSBridge server
    		if (listenerGPS != null) 
		{
      			listenerGPS.unsubscribe();
    		}
    		//window.alert("We failed to connect.");
    		ros.close();
    		connected = false;
  	} 
	else 
	{ // Connect to ROSBridge server
		var addr = document.getElementById("gps_addr").value;
		//window.alert("addr has bern set to: " + document.getElementById("gps_addr").value);
    		if (addr.length <= 0) 
		{
      			addr = "localhost:9090";
			//window.alert("No addr, so we set default.");
    		}
		var topic = document.getElementById("gps_topic").value;
		//window.alert("topic has been set to: " + document.getElementById("gps_topic").value);
    		if (topic.length <= 0) 
		{
      			topic = "/dn3/gps_chatter";
			//window.alert("No topic, so we set default.");
    		}
		//window.alert("Attempting to connect to: " + 'ws://' + addr);
    		ros.connect('ws://' + addr);
    		connected = true;
    		//window.alert("We connected.");
    		listenerGPS = new ROSLIB.Topic({
      		ros : ros,
      		name : topic,
      		messageType : 'sensor_msgs/NavSatFix'
    	});
    listenerGPS.subscribe(callbackGPS);
  }
};
</script>
</head>

<body>

<!-- ROSBridge Connection -->
<form>
  
<div class="ui-grid-a">
<div class="ui-block-a">
  <div data-role="fieldcontain">
  <label for="gps_ip">Address: </label>
  <input type="text" data-mini="true" data-clear-btn="true" name="gps_addr" id="gps_addr" value="localhost:9090" placeholder="localhost:9090" />
  </div>

  <div data-role="fieldcontain">
  <label for="gps_ip">GPS Topic: </label>
  <input type="text" data-mini="true" data-clear-btn="true" name="gps_topic" id="gps_topic" value="/dn3/gps_chatter" placeholder="/dn3/gps_chatter" />
  </div>

  <div data-role="fieldcontain">
  <label for="gps_connect" class="select">Connection: </label>
  <select data-role="slider" data-mini="true" name="gps_connect" id="gps_connect" onchange="toggleConnection()">
    <option value="0">Off</option>
    <option value="1">On</option>
  </select>
  </div>
</div>

<div class="ui-block-b">
  <div data-role="fieldcontain">
  <label for="gps_msg_rate">Max # msg/s: </label>
  <input type="text" data-mini="true" data-clear-btn="true" name="gps_msg_rate" id="gps_msg_rate" value="" placeholder="0 (= no limits)" />
  </div>

  <div data-role="fieldcontain">
  <label for="gps_max_num_markers">Max # markers: </label>
  <input type="text" data-mini="true" data-clear-btn="true" name="gps_max_num_markers" id="gps_max_num_markers" value="" placeholder="0 (= no limits)" />
  </div>

  <div data-role="fieldcontain">
  <button data-inline="true" data-mini="true" id="gps_clear_markers">Clear Markers</button>
  </div>
</div>
</div>
</form>

<div id="map-canvas"></div>

<div class="ui-grid-b">
<div class="ui-block-a">
  Latest GPS Msg:
</div>
<div class="ui-block-b">
  <input type="text" data-mini="true" readonly name="gps_latest_latlon" id="gps_latest_latlon" value="">
</div>
<div class="ui-block-c">
  <input type="text" data-mini="true" readonly name="gps_latest_time" id="gps_latest_time" value="">
</div>
</div>

</body>

</html> 
